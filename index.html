<html>
	<head>
		<title>
			spacex-launches.com
        </title>
        <style>
            body {
                font-family:Helvetica Neue;
                text-align:center;
            }
            h1 {   
                vertical-align:middle;
                font-size:36px;
                font-weight:bold;
                color:#aaa;
            }
        </style>
	</head>
	<body>
		<h1>SpaceX Launches</h1>
        <br />
        <br />

        <svg></svg>
        
        <input id="time" type="range" style="width:50%">

        <script src = "https://d3js.org/d3.v5.min.js"></script>
        <script>
            const width = 900;
            const height = 350;
            const textRotation = -40;

            const margin = ({top: 20, right: 20, bottom: 30, left: 20});
            const extent = [[margin.left, margin.top], [width - margin.right, height - margin.top]];

            const cx = d3.scaleTime()
                .domain([new Date("January 1, 2010 00:00:00"), new Date("January 2, 2020 00:00:00")]) //domain: use d3.max
                .range([margin.left, width - margin.right]);
            const originalcx = cx.copy();

            const cy = d3.scaleLinear()
                .domain([0,100])
                .range([height - margin.bottom - 15,margin.top]);
            
            function state(d){
                switch(d){
                    case 0: return "lightgrey";     // pending
                    case 1: return "lightgreen";    // success
                    case 2: return "orangered";     // failed
                    default: return "black";        // data error
                }
            }

            function site(d){
                switch(d){
                    case 0: return "grey";          // unknown
                    case 1: return "mediumpurple";  // vafb
                    case 2: return "chocolate";     // kc39
                    case 3: return "goldenrod";     // cc40
                    case 4: return "lightblue";     // boca
                    default: return "black";        // data error
                }
            }

            const snapshots = [new Date("2018-01-10"), new Date().setMilliseconds(0)];
            const launches = [
                {
                    name: "Launch A", 
                    uncertainty: [50,20], // 0 = certain, 100 = very uncertain
                    date: [new Date("2014-01-01"), new Date("2014-05-01")],
                    state: [0,1],
                    site: [0,3],
                    exist: [1,1]
                },
                {
                    name: "Launch B", 
                    uncertainty: [100,30], 
                    date: [new Date("2016-01-01"), new Date("2017-05-01")],
                    state: [0,0],
                    site: [0,3],
                    exist: [1,1]
                },
                {
                    name: "Launch C", 
                    uncertainty: [40,40], 
                    date: [new Date("2019-01-01"), new Date("2019-01-01")],
                    state: [0,0],
                    site: [0,1],
                    exist: [0,1]
                    },
                {
                    name: "Launch D", 
                    uncertainty: [10,5], 
                    date: [new Date("2018-02-01"), new Date("2019-05-01")],
                    state: [1,1],
                    site: [2,2],
                    exist: [1,1]
                }
            ];

            d3.select("#time")
                .attr("min", 0)
                .attr("max", launches[0].date.length-1)
                .attr("step", 1)
                .attr("value", launches[0].date.length-1);

            const slider = document.getElementById("time");
            slider.addEventListener("change", updateCircles);
            let t = slider.value;

            var svg = d3.select("svg")
                .attr("width",width)
                .attr("height",height);

            var circle = svg.selectAll("circle")
                .data(launches);
            var circleEnter = circle.enter().append("circle")
                .attr("r", 0)
                .attr("cx", d => cx(d.date[t]))
                .attr("cy", d => cy(d.uncertainty[t]));

            var text = svg.selectAll("text")
                .data(launches);
            var textEnter = text.enter().append("text")
                .attr("class", "names")
                .attr("text-anchor", "start")
                .attr("transform", d => "translate(" + cx(d.date[t]) + "," + cy(d.uncertainty[t]) + ") rotate(" + textRotation + ")")
                .text(d => d.name);
                
            
            var line = svg.append("line")
                .attr("x1", cx(snapshots[t]))
                .attr("y1", margin.top)
                .attr("x2", cx(snapshots[t]))
                .attr("y2", height - margin.bottom)
                .style("stroke-width", 2)
                .style("stroke", "#bbb");
            
            contUpdate();

            function contUpdate(){
                snapshots[snapshots.length-1] = new Date().setMilliseconds(0);
                line
                    .attr("x1", cx(snapshots[t]))
                    .attr("x2", cx(snapshots[t]));
                setTimeout(contUpdate, 1000);
            }
            
            updateCircles(); 

            function updateCircles()
            {
                
                t = slider.value;
                circleEnter
                    .transition()
                    .duration(750)
                    .attr("r", d => d.exist[t] == 1? 10: 0)
                    .attr("stroke-width", d => d.exist[t] == 1? 3: 0)
                    .attr("cx", d => cx(d.date[t]))
                    .attr("cy", d => cy(d.uncertainty[t]))
                    .attr("fill", d => site(d.site[t]))
                    .attr("stroke", d => state(d.state[t]));
                
                textEnter
                    .transition()
                    .duration(750)
                    .attr("font-size", d => d.exist[t] == 1? 12: 0)
                    .attr("transform", d => "translate(" + cx(d.date[t]) + "," + cy(d.uncertainty[t]) + ") rotate(" + textRotation + ")")
                    .attr("dx", 15)
                    .attr("dy", d => d.exist[t] == 1? 5: 0);
                
                line
                    .transition()
                    .duration(250)
                    .attr("x1", cx(snapshots[t]))
                    .attr("x2", cx(snapshots[t]));
            };
        

            var zoom = d3.zoom()
                .scaleExtent([1, 20000000])
                .translateExtent(extent)
                .extent(extent)
                .on("zoom", zoomed);
    
            var xAxis = d3.axisBottom(cx)
               .tickSize(5)
               .tickPadding(5);

            var gX = svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(xAxis);
            
            svg.call(zoom);

            function zoomed() {
                cx.range([margin.left, width - margin.right].map(d => d3.event.transform.applyX(d)));
                gX.call(xAxis.scale(d3.event.transform.rescaleX(originalcx)));
                circleEnter.attr("cx", d => cx(d.date[t]));
                textEnter.attr("transform", d => "translate(" + cx(d.date[t]) + "," + cy(d.uncertainty[t]) + ") rotate(" + textRotation + ")");
                line.attr("x1", cx(snapshots[t])).attr("x2", cx(snapshots[t]));
                }

        </script>
	</body>
</html>
